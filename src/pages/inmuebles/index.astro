---
/**
 * Página de listado de inmuebles de Emblematic
 *
 * URL: /inmuebles
 *
 * Muestra todas las propiedades del CRM Emblematic con filtros
 * Mismo diseño visual que /propiedades
 */

import MainLayout from '../../components/layout/MainLayout.astro';
import PropertyHero from '../../components/properties/PropertyHero.astro';
import PropertyIntro from '../../components/properties/PropertyIntro.astro';
import EmblematicFilters from '../../components/emblematic/EmblematicFilters';
import PropertyGrid from '../../components/properties/PropertyGrid';
import EmblematicMap from '../../components/emblematic/EmblematicMap.astro';
import FinalCTA from '../../components/home/FinalCTA';
import type { Property } from '../../types/property';

const API_BASE = import.meta.env.PUBLIC_API_URL || 'http://localhost:4000';

// Placeholder para propiedades sin imagen
const PLACEHOLDER_IMAGE = "https://placehold.co/800x600/e5e7eb/9ca3af?text=Sin+imagen";

// Obtener configuración de la página desde la base de datos
let heroTitle = "Inmuebles en venta y alquiler";
let heroImages: any[] = [];

try {
  const pageSettingsRes = await fetch(`${API_BASE}/api/pages/properties`);
  if (pageSettingsRes.ok) {
    const pageData = await pageSettingsRes.json();
    if (pageData.data?.title) {
      heroTitle = pageData.data.title;
    }
  }

  const heroImagesRes = await fetch(`${API_BASE}/api/hero-images?pageKey=properties`);
  if (heroImagesRes.ok) {
    const imagesData = await heroImagesRes.json();
    heroImages = imagesData.data || [];
  }
} catch (error) {
  console.error("Error al obtener configuración del hero", error);
}

// Obtener parámetros de búsqueda de la URL
const url = new URL(Astro.request.url);
const page = parseInt(url.searchParams.get('page') || '1');
const modeId = url.searchParams.get('mode_id');
const typeId = url.searchParams.get('type_id');
const subtypeId = url.searchParams.get('subtype_id');
const priceMin = url.searchParams.get('price_min');
const priceMax = url.searchParams.get('price_max');
const rooms = url.searchParams.get('rooms');
const city = url.searchParams.get('city');
const searchQuery = url.searchParams.get('q');

// Construir query params para la API de Emblematic
const queryParams = new URLSearchParams();
queryParams.set('page', String(page));
if (modeId) queryParams.set('mode_id', modeId);
if (typeId) queryParams.set('type_id', typeId);
if (subtypeId) queryParams.set('subtype_id', subtypeId);
if (priceMin) queryParams.set('price_min', priceMin);
if (priceMax) queryParams.set('price_max', priceMax);
if (rooms) queryParams.set('rooms', rooms);
if (city) queryParams.set('city', city);

let properties: Property[] = [];
let totalResults = 0;
let lastPage = 1;
let currentPage = 1;

try {
  const apiUrl = `${API_BASE}/api/emblematic/properties?${queryParams.toString()}`;
  console.log('[Inmuebles Page] Fetching:', apiUrl);
  const response = await fetch(apiUrl);
  const result = await response.json();
  console.log('[Inmuebles Page] Response:', result.success, 'Properties:', result.data?.properties?.length || 0);

  if (result.success && result.data) {
    const emblematicProperties = result.data.properties || [];
    totalResults = result.data.total || 0;
    lastPage = result.data.lastPage || 1;
    currentPage = result.data.currentPage || 1;

    // Filtrar por búsqueda de texto si existe
    let filteredProperties = emblematicProperties;
    if (searchQuery) {
      const query = searchQuery.toLowerCase();
      filteredProperties = emblematicProperties.filter((p: any) =>
        p.title?.toLowerCase().includes(query) ||
        p.city?.toLowerCase().includes(query) ||
        p.zone?.toLowerCase().includes(query) ||
        p.description?.toLowerCase().includes(query)
      );
      totalResults = filteredProperties.length;
    }

    // Mapear propiedades de Emblematic al formato Property
    properties = filteredProperties.map((p: any) => ({
      id: p.reference,
      title: p.title,
      slug: p.canonicalUrl, // URL completa tipo /3/piso-en-sanlucar
      price: p.price || 0,
      city: p.city || '',
      neighborhood: p.zone || '',
      operation: p.operation === 'RENT' ? 'ALQUILER' : 'VENTA',
      propertyType: p.propertySubtype || p.propertyType || '',
      areaM2: p.area || p.areaBuilt || null,
      bedrooms: p.rooms || null,
      bathrooms: p.bathrooms || null,
      imageUrl: p.images?.[0] || PLACEHOLDER_IMAGE,
      isFeatured: false, // Emblematic no tiene campo destacado
    }));
  }
} catch (error) {
  console.error('Error al obtener propiedades de Emblematic:', error);
}

// Calcular información de paginación
const limit = 6;
const totalPages = Math.max(lastPage, Math.ceil(totalResults / limit));
const hasNextPage = currentPage < totalPages;
const hasPrevPage = currentPage > 1;

// Filtrar solo imágenes activas y ordenarlas
const activeHeroImages = heroImages
  .filter((img: any) => img.active)
  .sort((a: any, b: any) => a.order - b.order);

// Helper para construir URLs de paginación
function buildPaginationUrl(pageNum: number): string {
  const params = new URLSearchParams();
  if (modeId) params.set('mode_id', modeId);
  if (typeId) params.set('type_id', typeId);
  if (subtypeId) params.set('subtype_id', subtypeId);
  if (priceMin) params.set('price_min', priceMin);
  if (priceMax) params.set('price_max', priceMax);
  if (rooms) params.set('rooms', rooms);
  if (city) params.set('city', city);
  if (searchQuery) params.set('q', searchQuery);
  params.set('page', String(pageNum));
  return `/inmuebles?${params.toString()}#properties-grid`;
}

const hasActiveFilters = modeId || typeId || subtypeId || priceMin || priceMax || rooms || city || searchQuery;
---

<MainLayout
  title={`${heroTitle} | Inmobiliaria Korvalia`}
  description="Encuentra pisos, casas y chalets en venta y alquiler. Propiedades seleccionadas con atención personalizada."
>
  <!-- Hero -->
  <PropertyHero title={heroTitle} heroImages={activeHeroImages} />

  <!-- Introducción -->
  <PropertyIntro />

  <!-- Filtros -->
  <EmblematicFilters client:load />

  <!-- Grid de propiedades -->
  <section id="properties-grid" class="properties-section">
    <div class="container">
      <!-- Indicador de resultados de búsqueda -->
      {searchQuery && (
        <div class="search-results-banner">
          <div class="search-results-content">
            <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 100-15 7.5 7.5 0 000 15z"
              />
            </svg>
            <span class="search-results-text">
              {totalResults > 0
                ? `Resultados de búsqueda para "${searchQuery}": ${totalResults} ${totalResults === 1 ? "propiedad encontrada" : "propiedades encontradas"}`
                : `No se encontraron propiedades para "${searchQuery}"`}
            </span>
            <a href="/inmuebles" class="clear-search">
              <svg class="close-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </a>
          </div>
        </div>
      )}

      <!-- Indicador de filtros activos (sin búsqueda) -->
      {hasActiveFilters && !searchQuery && (
        <div class="search-results-banner">
          <div class="search-results-content">
            <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"
              />
            </svg>
            <span class="search-results-text">
              {totalResults} {totalResults === 1 ? "propiedad encontrada" : "propiedades encontradas"} con los filtros aplicados
            </span>
            <a href="/inmuebles" class="clear-search">
              <svg class="close-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </a>
          </div>
        </div>
      )}

      <PropertyGrid properties={properties} client:load />

      <!-- Paginación -->
      {totalPages > 1 && (
        <div class="pagination-wrapper">
          <div class="pagination">
            {hasPrevPage && (
              <a href={buildPaginationUrl(currentPage - 1)} class="pagination-btn">
                ← Anterior
              </a>
            )}

            <span class="pagination-info">
              Página {currentPage} de {totalPages}
            </span>

            {hasNextPage && (
              <a href={buildPaginationUrl(currentPage + 1)} class="pagination-btn">
                Siguiente →
              </a>
            )}
          </div>
        </div>
      )}
    </div>
  </section>

  <!-- Mapa con propiedades de Emblematic -->
  <EmblematicMap />

  <!-- CTA Final -->
  <section class="cta-wrapper">
    <FinalCTA client:load source="cta_properties" />
  </section>
</MainLayout>

<style>
  .properties-section {
    padding: 3rem 0 4rem;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  .search-results-banner {
    background: linear-gradient(135deg, #133b34 0%, #39505d 100%);
    border-radius: 12px;
    padding: 1rem 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .search-results-content {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: white;
  }

  .search-icon {
    width: 1.25rem;
    height: 1.25rem;
    flex-shrink: 0;
  }

  .search-results-text {
    flex: 1;
    font-size: 0.95rem;
    font-weight: 500;
  }

  .clear-search {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    transition: all 0.2s;
    flex-shrink: 0;
  }

  .clear-search:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
  }

  .close-icon {
    width: 1rem;
    height: 1rem;
    color: white;
  }

  .pagination-wrapper {
    display: flex;
    justify-content: center;
    margin-top: 3rem;
  }

  .pagination {
    display: flex;
    align-items: center;
    gap: 1.5rem;
  }

  .pagination-btn {
    padding: 0.75rem 1.5rem;
    background: #39505d;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .pagination-btn:hover {
    background: #2d3f4a;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(57, 80, 93, 0.3);
  }

  .pagination-info {
    color: #39505d;
    font-weight: 500;
    font-size: 0.95rem;
  }

  .cta-wrapper {
    background: white;
  }
</style>
