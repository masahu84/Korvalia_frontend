---
/**
 * Tarjeta de propiedad de Emblematic
 * Muestra una propiedad del CRM externo en formato card
 */

interface Props {
  reference: string;
  title: string;
  price: number;
  operation: 'SALE' | 'RENT';
  propertySubtype: string;
  city: string;
  zone?: string;
  rooms?: number;
  bathrooms?: number;
  area?: number;
  images: string[];
  canonicalUrl: string;
}

const {
  reference,
  title,
  price,
  operation,
  propertySubtype,
  city,
  zone,
  rooms,
  bathrooms,
  area,
  images,
  canonicalUrl,
} = Astro.props;

// Formatear precio
const formattedPrice = new Intl.NumberFormat('es-ES', {
  style: 'currency',
  currency: 'EUR',
  maximumFractionDigits: 0,
}).format(price);

// Etiqueta de operación
const operationLabel = operation === 'RENT' ? 'Alquiler' : 'Venta';
const operationClass = operation === 'RENT' ? 'rent' : 'sale';

// Imagen principal o placeholder
const mainImage = images?.[0] || '/placeholder-property.jpg';

// Ubicación completa
const location = zone ? `${city}, ${zone}` : city;
---

<a href={canonicalUrl} class="property-card">
  <div class="property-image">
    <img src={mainImage} alt={title} loading="lazy" />
    <span class={`operation-badge ${operationClass}`}>{operationLabel}</span>
    <span class="reference-badge">Ref: {reference}</span>
    <button
      class="share-button"
      data-title={title}
      data-url={`https://korvalia.es${canonicalUrl}`}
      data-price={formattedPrice}
      aria-label="Compartir propiedad"
    >
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="18" cy="5" r="3"/>
        <circle cx="6" cy="12" r="3"/>
        <circle cx="18" cy="19" r="3"/>
        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
      </svg>
    </button>
  </div>

  <div class="property-content">
    <h3 class="property-title">{title}</h3>
    <p class="property-location">{location}</p>

    <div class="property-features">
      {rooms && (
        <span class="feature">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
          </svg>
          {rooms} hab.
        </span>
      )}
      {bathrooms && (
        <span class="feature">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 12h16M4 12a2 2 0 01-2-2V6a2 2 0 012-2h1a2 2 0 012 2v1m-3 5v6a2 2 0 002 2h12a2 2 0 002-2v-6" />
          </svg>
          {bathrooms} baños
        </span>
      )}
      {area && (
        <span class="feature">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
          </svg>
          {area} m²
        </span>
      )}
    </div>

    <div class="property-price">
      {formattedPrice}
      {operation === 'RENT' && <span class="price-suffix">/mes</span>}
    </div>
  </div>
</a>

<style>
  .property-card {
    display: block;
    background: white;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    text-decoration: none;
    color: inherit;
  }

  .property-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
  }

  .property-image {
    position: relative;
    aspect-ratio: 4/3;
    overflow: hidden;
  }

  .property-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .property-card:hover .property-image img {
    transform: scale(1.05);
  }

  .operation-badge {
    position: absolute;
    top: 12px;
    left: 12px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .operation-badge.sale {
    background: #133b34;
    color: white;
  }

  .operation-badge.rent {
    background: #3b82f6;
    color: white;
  }

  .reference-badge {
    position: absolute;
    top: 12px;
    right: 12px;
    padding: 4px 8px;
    background: rgba(0, 0, 0, 0.6);
    color: white;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 500;
  }

  .share-button {
    position: absolute;
    bottom: 12px;
    right: 12px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    transition: transform 0.2s, box-shadow 0.2s;
    z-index: 10;
  }

  .share-button:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  .share-button:active {
    transform: scale(0.95);
  }

  .share-button svg {
    width: 20px;
    height: 20px;
    color: #133b34;
  }

  .property-content {
    padding: 1.25rem;
  }

  .property-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #1f2937;
    margin: 0 0 0.5rem 0;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .property-location {
    font-size: 0.875rem;
    color: #6b7280;
    margin: 0 0 1rem 0;
  }

  .property-features {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .feature {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.8125rem;
    color: #4b5563;
  }

  .feature svg {
    width: 16px;
    height: 16px;
    color: #9ca3af;
  }

  .property-price {
    font-size: 1.375rem;
    font-weight: 700;
    color: #133b34;
  }

  .price-suffix {
    font-size: 0.875rem;
    font-weight: 500;
    color: #6b7280;
  }

  @media (max-width: 640px) {
    .property-content {
      padding: 1rem;
    }

    .property-title {
      font-size: 1rem;
    }

    .property-price {
      font-size: 1.25rem;
    }
  }
</style>

<script>
  // Funcionalidad de compartir propiedad
  document.addEventListener('click', async (e) => {
    const button = (e.target as HTMLElement).closest('.share-button');
    if (!button) return;

    // Evitar que el click navegue al enlace de la card
    e.preventDefault();
    e.stopPropagation();

    const title = button.getAttribute('data-title') || 'Propiedad en Korvalia';
    const url = button.getAttribute('data-url') || window.location.href;
    const price = button.getAttribute('data-price') || '';

    const shareText = `${title} - ${price}\n\nMira esta propiedad en Korvalia:`;

    // Usar Web Share API si está disponible (móviles)
    if (navigator.share) {
      try {
        await navigator.share({
          title: title,
          text: shareText,
          url: url,
        });
      } catch (err) {
        // Usuario canceló o error
        console.log('Compartir cancelado');
      }
    } else {
      // Fallback para desktop: copiar al portapapeles
      const fullText = `${shareText}\n${url}`;
      try {
        await navigator.clipboard.writeText(fullText);
        // Mostrar feedback visual
        const originalHTML = button.innerHTML;
        button.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
        setTimeout(() => {
          button.innerHTML = originalHTML;
        }, 2000);
      } catch (err) {
        console.error('Error al copiar:', err);
      }
    }
  });
</script>
