---
// Sección con imagen a la izquierda y formulario a la derecha
// La imagen se carga dinámicamente desde el backend
const API_BASE = import.meta.env.PUBLIC_API_URL || "http://localhost:4000";

// Helper para construir URLs completas de imágenes
function getImageUrl(url: string): string {
  if (!url) return "";
  if (url.startsWith("http://") || url.startsWith("https://")) {
    return url;
  }
  return url.startsWith("/") ? `${API_BASE}${url}` : `${API_BASE}/${url}`;
}

// Imagen por defecto
let heroImage = "https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?w=1200&h=800&fit=crop&q=80";

// Cargar imagen desde el backend
try {
  const response = await fetch(`${API_BASE}/api/pages/contact`);
  if (response.ok) {
    const result = await response.json();
    const blocks = result.data?.blocks || {};

    if (blocks.heroImage) {
      heroImage = getImageUrl(blocks.heroImage);
    }
  }
} catch (error) {
  console.error("Error al cargar imagen de contacto:", error);
}
---

<section class="contact-form-section">
  <div class="container">
    <div class="contact-layout">
      <!-- Imagen de fondo principal -->
      <div class="image-wrapper">
        <img
          src={heroImage}
          alt="Contacto Korvalia"
          class="contact-image"
        />
      </div>

      <!-- Formulario flotando sobre la imagen -->
      <div class="form-card">
        <form class="contact-form" id="main-contact-form">
          <div class="form-group">
            <label for="contact-name" class="form-label">Nombre</label>
            <input type="text" id="contact-name" name="name" class="form-input" placeholder="Nombre" required />
          </div>

          <div class="form-group">
            <label for="contact-surname" class="form-label">Apellidos</label>
            <input type="text" id="contact-surname" name="surname" class="form-input" placeholder="Apellidos" />
          </div>

          <div class="form-group">
            <label for="contact-phone" class="form-label">Número de teléfono</label>
            <input type="tel" id="contact-phone" name="phone" class="form-input" placeholder="Número de teléfono" />
          </div>

          <div class="form-group">
            <label for="contact-email" class="form-label">Email</label>
            <input type="email" id="contact-email" name="email" class="form-input" placeholder="Email" required />
          </div>

          <div class="form-group">
            <label for="contact-city" class="form-label">Ciudad</label>
            <input type="text" id="contact-city" name="city" class="form-input" placeholder="Ciudad" />
          </div>

          <div class="form-group">
            <label for="contact-message" class="form-label">Mensaje</label>
            <textarea
              id="contact-message"
              name="message"
              class="form-textarea"
              rows="3"
              placeholder="¡Hola! Estoy interesad@ en..."></textarea>
          </div>

          <div id="form-message" class="form-message" style="display: none;"></div>

          <div class="form-actions">
            <button type="submit" class="btn-send" id="btn-submit">Enviar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

<style>
  .contact-form-section {
    padding: 3rem 0 4rem;
    background: white;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  .contact-layout {
    position: relative;
    display: flex;
    justify-content: flex-start;
    padding-right: 0;
  }

  .image-wrapper {
    flex: 1;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.18);
    min-height: 380px;
  }

  .contact-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .form-card {
    position: absolute;
    right: -2.8rem;
    top: 50%;
    transform: translateY(-50%);
    max-width: 380px;
    width: 100%;
    background: #ffffff;
    border-radius: 18px;
    padding: 1.4rem 1.7rem 1.35rem;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.18);
  }

  .contact-form {
    display: flex;
    flex-direction: column;
    gap: 0.85rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .form-label {
    font-size: 0.8rem;
    font-weight: 500;
    color: #6b7280;
  }

  .form-input,
  .form-textarea {
    width: 100%;
    padding: 0.7rem 0.95rem;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.9375rem;
    color: #374151;
    background: white;
    transition: all 0.2s;
  }

  .form-input::placeholder,
  .form-textarea::placeholder {
    color: #9ca3af;
  }

  .form-input:focus,
  .form-textarea:focus {
    outline: none;
    border-color: #133b34;
    box-shadow: 0 0 0 3px rgba(19, 59, 52, 0.12);
  }

  .form-textarea {
    resize: vertical;
    min-height: 72px;
  }

  .form-message {
    padding: 0.75rem;
    border-radius: 8px;
    font-size: 0.875rem;
    text-align: center;
  }

  .form-message.success {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #10b981;
  }

  .form-message.error {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #dc2626;
  }

  .form-actions {
    display: flex;
    justify-content: center;
    margin-top: 0.6rem;
  }

  .btn-send {
    padding: 0.8rem 2.8rem;
    border: none;
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
    background: #4b5563;
    color: #ffffff;
  }

  .btn-send:hover:not(:disabled) {
    background: #374151;
    transform: translateY(-1px);
    box-shadow: 0 6px 16px rgba(55, 65, 81, 0.35);
  }

  .btn-send:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  @media (max-width: 900px) {
    .contact-layout {
      flex-direction: column;
    }

    .image-wrapper {
      border-radius: 16px;
      min-height: 260px;
    }

    .form-card {
      position: static;
      transform: none;
      max-width: 100%;
      margin-top: 1.75rem;
      right: 0;
    }
  }

  @media (max-width: 640px) {
    .form-card {
      padding: 1.5rem 1.3rem 1.3rem;
    }
  }
</style>

<script is:inline define:vars={{ API_BASE }}>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("main-contact-form");
    const submitBtn = document.getElementById("btn-submit");
    const messageDiv = document.getElementById("form-message");

    if (form && submitBtn && messageDiv) {
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Deshabilitar botón mientras se envía
        submitBtn.disabled = true;
        submitBtn.textContent = "Enviando...";
        messageDiv.style.display = "none";

        const formData = new FormData(form);
        const data = Object.fromEntries(formData);

        try {
          const response = await fetch(`${API_BASE}/api/contact`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          });

          const result = await response.json();

          if (response.ok && result.success) {
            messageDiv.className = "form-message success";
            messageDiv.textContent = "¡Gracias por contactarnos! Te responderemos pronto.";
            messageDiv.style.display = "block";
            form.reset();
          } else {
            messageDiv.className = "form-message error";
            messageDiv.textContent = result.error || "Error al enviar el mensaje. Inténtalo de nuevo.";
            messageDiv.style.display = "block";
          }
        } catch (error) {
          console.error("Error al enviar formulario:", error);
          messageDiv.className = "form-message error";
          messageDiv.textContent = "Error de conexión. Por favor, inténtalo de nuevo.";
          messageDiv.style.display = "block";
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = "Enviar";
        }
      });
    }
  });
</script>
