---
// Sección de testimonio de cliente - Dinámico desde la base de datos
const API_BASE = import.meta.env.PUBLIC_API_URL || "http://localhost:4000";

// Valores por defecto
let testimonialName = "Merche Silva";
let testimonialRole = "La persona detrás de Korvalia";
let testimonialText =
  "Korvalia está liderada por Merche Silva, cuya experiencia y manera de trabajar se basan en la claridad, la cercanía y el compromiso personal.\nSu objetivo es que cada cliente se sienta acompañado, escuchado y en un entorno de confianza desde el primer día.\nSu visión de una inmobiliaria más humana, más clara y más eficiente es la base del proyecto.";
let testimonialImage = "/merche.png";

try {
  const response = await fetch(`${API_BASE}/api/pages/home`);
  if (response.ok) {
    const result = await response.json();
    const data = result.data || {};

    if (data.testimonialName) {
      testimonialName = data.testimonialName;
    }
    if (data.testimonialRole) {
      testimonialRole = data.testimonialRole;
    }
    if (data.testimonialText) {
      testimonialText = data.testimonialText;
    }
    if (data.testimonialImage) {
      // Construir URL completa de la imagen
      if (data.testimonialImage.startsWith("http://") || data.testimonialImage.startsWith("https://")) {
        testimonialImage = data.testimonialImage;
      } else {
        testimonialImage = data.testimonialImage.startsWith("/")
          ? `${API_BASE}${data.testimonialImage}`
          : `${API_BASE}/${data.testimonialImage}`;
      }
    }
  }
} catch (error) {
  console.error("Error al cargar testimonial:", error);
}

// Procesar el texto: separar por doble salto de línea para párrafos
// y mantener los saltos simples dentro de cada párrafo
const paragraphs = testimonialText
  .split(/\n\n+/)
  .map((p) => p.trim())
  .filter((p) => p.length > 0);
---

<section class="testimonial">
  <div class="container">
    <div class="testimonial-content">
      <!-- Foto circular con borde -->
      <div class="testimonial-image-wrapper">
        <div class="image-circle">
          <img src={testimonialImage} alt={testimonialName} class="avatar" />
        </div>
      </div>

      <!-- Contenido del testimonio -->
      <div class="testimonial-text">
        <h2 class="testimonial-name">{testimonialName}</h2>
        <p class="testimonial-role">{testimonialRole}</p>

        <div
          class="testimonial-description"
          set:html={`<p>${testimonialText.replace(/\n\n+/g, "</p><p>").replace(/\n/g, "<br/>")}</p>`}
        />
      </div>
    </div>
  </div>
</section>

<style>
  .testimonial {
    padding: 5rem 0;
    background: #ffffff;
  }

  .container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  .testimonial-content {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 4rem;
    align-items: center;
  }

  @media (max-width: 768px) {
    .testimonial-content {
      grid-template-columns: 1fr;
      text-align: center;
      gap: 2.5rem;
    }

    .testimonial-image-wrapper {
      justify-self: center;
    }
  }

  .testimonial-image-wrapper {
    position: relative;
  }

  .image-circle {
    width: 320px;
    height: 320px;
    border-radius: 50%;
    background: #c8dce8;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  .avatar {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center 50%;
  }

  @media (max-width: 768px) {
    .image-circle {
      width: 240px;
      height: 240px;
    }
  }

  .testimonial-text {
    flex: 1;
  }

  .testimonial-name {
    font-family: "Montserrat", system-ui, sans-serif;
    font-size: 2.25rem;
    font-weight: 600;
    color: #39505d;
    margin: 0 0 0.5rem 0;
  }

  .testimonial-role {
    font-size: 1.1rem;
    color: #133b34;
    font-weight: 600;
    margin: 0 0 1.75rem 0;
  }

  .testimonial-description {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .testimonial-description p {
    font-size: 0.95rem;
    line-height: 1.7;
    color: #5a6b6a;
    margin: 0;
  }

  @media (max-width: 768px) {
    .testimonial-name {
      font-size: 1.75rem;
    }

    .testimonial-role {
      font-size: 1rem;
    }

    .testimonial-description p {
      font-size: 0.9375rem;
    }
  }
</style>
