---
import PropertyGrid from "../properties/PropertyGrid";
import type { Property } from "../../types/property";

const API_BASE = import.meta.env.PUBLIC_API_URL ?? "http://localhost:4000";

// Placeholder para propiedades sin imagen
const PLACEHOLDER_IMAGE = "https://placehold.co/800x600/e5e7eb/9ca3af?text=Sin+imagen";

let allProperties: Property[] = [];
let homeSubtitle = "Una nueva forma de vivir y de vender en Sanlúcar"; // Valor por defecto

// Cargar configuración de la home para obtener el subtítulo
try {
  const homeRes = await fetch(`${API_BASE}/api/pages/home`);
  if (homeRes.ok) {
    const homeJson = await homeRes.json();
    if (homeJson.data?.subtitle) {
      homeSubtitle = homeJson.data.subtitle;
    }
  }
} catch (error) {
  console.error("Error al obtener configuración de home", error);
}

// Obtener propiedades SOLO del CRM Emblematic (propiedades destacadas/latest)
try {
  const emblematicRes = await fetch(`${API_BASE}/api/emblematic/properties/featured`);
  console.log("Emblematic response:", emblematicRes);
  if (emblematicRes.ok) {
    const emblematicJson = await emblematicRes.json();
    if (emblematicJson.success && emblematicJson.data) {
      // Usar propiedades destacadas primero, si no hay usar las últimas
      const emblematicProperties = [
        ...(emblematicJson.data.featured || []),
        ...(emblematicJson.data.latest || []),
      ];

      if (emblematicProperties.length > 0) {
        allProperties = emblematicProperties.map((p: any) => {
          // Generar título sin dirección exacta
          const propertyTypeName = p.propertySubtype || p.propertyType || 'Inmueble';
          const locationPart = p.zone ? `${p.zone}, ${p.city}` : p.city;
          const safeTitle = `${propertyTypeName} en ${locationPart}`;

          return {
            id: p.reference,
            title: safeTitle,
            slug: p.canonicalUrl,
            price: p.price,
            city: p.city ?? "",
            neighborhood: p.zone ?? "",
            operation: p.operation === "RENT" ? "ALQUILER" : "VENTA",
            propertyType: p.propertySubtype ?? p.propertyType ?? "",
            areaM2: p.area ?? p.areaBuilt ?? 0,
            bedrooms: p.rooms ?? 0,
            bathrooms: p.bathrooms ?? 0,
            imageUrl: p.images?.[0] || PLACEHOLDER_IMAGE,
            isFeatured: true,
          };
        });
      }
    }
  }
} catch (error) {
  console.error("Error al obtener propiedades de Emblematic:", error);
}

// Mostrar solo las primeras 6 propiedades
const properties = allProperties.slice(0, 6);
const hasMore = allProperties.length > 6;
const hasProperties = properties.length > 0;
---

<section class="bg-white pt-20 lg:pt-28 pb-20 lg:pb-24">
  <!-- BLOQUE 1: texto + botones (contenedor 1, fondo blanco y más alto) -->
  <div class="container mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center mb-16 lg:mb-20">
      <h2 class="text-xl sm:text-2xl lg:text-3xl font-medium mb-8 leading-relaxed max-w-3xl mx-auto" style="color: #39505d;">
        {homeSubtitle}
      </h2>

      <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
        <a
          href="/inmuebles"
          class="inline-flex items-center justify-center rounded-md px-7 py-3 text-sm font-semibold text-white transition"
          style="background: #133b34;"
          onmouseover="this.style.background='#0f2d27'"
          onmouseout="this.style.background='#133b34'"
        >
          Ver propiedades
        </a>
        <a
          href="/contacto"
          class="inline-flex items-center justify-center rounded-md px-7 py-3 text-sm font-semibold text-white transition"
          style="background: #39505d;"
          onmouseover="this.style.background='#2d3f4a'"
          onmouseout="this.style.background='#39505d'"
        >
          Vender mi vivienda
        </a>
      </div>
    </div>
  </div>

  <!-- BLOQUE 2: contenedor 2, fondo celeste en la parte superior + cards -->
  <div class="relative mt-12 lg:mt-16">
    {
      /*
      Banda celeste:
      - Se posiciona respecto a ESTE bloque.
      - Cubre título, subtítulo, buscador y parte superior de las cards.
    */
    }
    <div class="absolute inset-x-0 top-0 h-[380px] sm:h-[400px] bg-[#dbeaf5]"></div>

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
      <!-- Título y subtítulo dentro de la franja celeste -->
      <div class="text-center pt-4 sm:pt-6 mb-6 lg:pt-8 lg:mb-8">
        <h3 class="text-3xl sm:text-4xl font-bold mb-2" style="color: #39505d;">Propiedades seleccionadas para ti</h3>
        <p class="text-sm sm:text-base" style="color: #6a8074;">
          Una selección de inmuebles que cumplen nuestro estándar de calidad.
        </p>
      </div>

      <!-- Buscador centrado (sobre fondo celeste) -->
      <div class="max-w-lg mx-auto mb-8 lg:mb-10">
        <form id="home-search-form" class="flex gap-2">
          <div class="relative flex-1">
            <label class="sr-only" for="home-search">Buscar</label>
            <span class="pointer-events-none absolute inset-y-0 left-4 flex items-center">
              <svg class="h-5 w-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 100-15 7.5 7.5 0 000 15z"></path>
              </svg>
            </span>
            <input
              id="home-search"
              name="q"
              type="search"
              placeholder="Buscar propiedades..."
              class="w-full rounded-xl border border-slate-200 bg-white py-3 pl-11 pr-4 text-sm sm:text-base shadow-sm focus:outline-none focus:ring-2 focus:ring-slate-900/70 focus:border-transparent"
            />
          </div>
          <button
            type="submit"
            class="px-5 py-3 rounded-xl text-white font-semibold text-sm sm:text-base transition-all hover:opacity-90 active:scale-95"
            style="background: #133b34;"
          >
            Buscar
          </button>
        </form>
      </div>

      <script>
        // Manejar búsqueda desde Home con redirección al grid
        document.getElementById("home-search-form")?.addEventListener("submit", function (e) {
          e.preventDefault();
          const input = document.getElementById("home-search") as HTMLInputElement;
          const query = input?.value?.trim();
          if (query) {
            window.location.href = `/inmuebles?q=${encodeURIComponent(query)}&page=1`;
          }
        });
      </script>

      <!-- Grid de propiedades o mensaje si no hay -->
      {hasProperties ? (
        <Fragment>
          <PropertyGrid properties={properties} client:load />

          <!-- Botón "Ver más" si hay más de 6 propiedades -->
          {hasMore && (
            <div class="text-center mt-12 lg:mt-14">
              <a
                href="/inmuebles"
                class="inline-flex items-center justify-center rounded-md px-8 py-3 text-sm font-semibold text-white transition"
                style="background: #133b34;"
                onmouseover="this.style.background='#0f2d27'"
                onmouseout="this.style.background='#133b34'"
              >
                Ver más propiedades
              </a>
            </div>
          )}
        </Fragment>
      ) : (
        <div class="bg-white rounded-2xl shadow-sm p-12 text-center max-w-2xl mx-auto">
          <div class="mb-6">
            <svg class="w-20 h-20 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
          </div>
          <h4 class="text-xl font-semibold text-gray-800 mb-3">Próximamente disponibles</h4>
          <p class="text-gray-500 mb-6 leading-relaxed">
            Estamos preparando una selección exclusiva de propiedades para ti.
            Muy pronto podrás explorar las mejores opciones del mercado.
          </p>
          <a
            href="/contacto"
            class="inline-flex items-center justify-center rounded-md px-6 py-3 text-sm font-semibold text-white transition"
            style="background: #133b34;"
            onmouseover="this.style.background='#0f2d27'"
            onmouseout="this.style.background='#133b34'"
          >
            Contáctanos para más información
          </a>
        </div>
      )}
    </div>
  </div>
</section>
