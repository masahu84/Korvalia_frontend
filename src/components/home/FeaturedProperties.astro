---
import PropertyGrid from "../properties/PropertyGrid";
import type { Property } from "../../types/property";

const API_BASE = import.meta.env.PUBLIC_API_URL ?? "http://localhost:4000";

// Placeholder para propiedades sin imagen
const PLACEHOLDER_IMAGE = "https://placehold.co/800x600/e5e7eb/9ca3af?text=Sin+imagen";

// Helper para construir URLs completas de imágenes
function getImageUrl(url: string): string {
  if (!url) return PLACEHOLDER_IMAGE;
  if (url.startsWith("http://") || url.startsWith("https://")) {
    return url;
  }
  return url.startsWith("/") ? `${API_BASE}${url}` : `${API_BASE}/${url}`;
}

let allProperties: Property[] = [];
let homeSubtitle = "Una nueva forma de vivir y de vender en Sanlúcar"; // Valor por defecto

// Cargar configuración de la home para obtener el subtítulo
try {
  const homeRes = await fetch(`${API_BASE}/api/pages/home`);
  if (homeRes.ok) {
    const homeJson = await homeRes.json();
    if (homeJson.data?.subtitle) {
      homeSubtitle = homeJson.data.subtitle;
    }
  }
} catch (error) {
  console.error("Error al obtener configuración de home", error);
}

try {
  // Solicitar todas las propiedades destacadas (limit=100)
  const res = await fetch(`${API_BASE}/api/properties/featured?limit=100`);
  if (res.ok) {
    const json = await res.json();
    allProperties =
      (json.data ?? []).map((p: any) => ({
        id: p.id,
        title: p.title,
        slug: p.slug,
        price: p.price,
        city: p.city?.name ?? p.city ?? "",
        neighborhood: p.neighborhood ?? "",
        operation: p.operation,
        propertyType: p.propertyType,
        areaM2: p.areaM2,
        bedrooms: p.bedrooms,
        bathrooms: p.bathrooms,
        imageUrl: getImageUrl(p.images?.[0]?.url || p.mainImageUrl || ""),
        isFeatured: true, // Las propiedades destacadas siempre tienen isFeatured: true
      })) || [];
  }
} catch (error) {
  console.error("Error al obtener propiedades destacadas", error);
}

// Mostrar solo las primeras 6 propiedades
const properties = allProperties.slice(0, 6);
const hasMore = allProperties.length > 6;
---

<section class="bg-white pt-20 lg:pt-28 pb-20 lg:pb-24">
  <!-- BLOQUE 1: texto + botones (contenedor 1, fondo blanco y más alto) -->
  <div class="container mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center mb-16 lg:mb-20">
      <h2 class="text-2xl sm:text-3xl lg:text-4xl font-semibold mb-8 leading-snug" style="color: #39505d;">
        {homeSubtitle}
      </h2>

      <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
        <a
          href="/propiedades"
          class="inline-flex items-center justify-center rounded-md px-7 py-3 text-sm font-semibold text-white transition"
          style="background: #133b34;"
          onmouseover="this.style.background='#0f2d27'"
          onmouseout="this.style.background='#133b34'"
        >
          Ver propiedades
        </a>
        <a
          href="/contacto"
          class="inline-flex items-center justify-center rounded-md px-7 py-3 text-sm font-semibold text-white transition"
          style="background: #39505d;"
          onmouseover="this.style.background='#2d3f4a'"
          onmouseout="this.style.background='#39505d'"
        >
          Vender mi vivienda
        </a>
      </div>
    </div>
  </div>

  <!-- BLOQUE 2: contenedor 2, fondo celeste en la parte superior + cards -->
  <div class="relative mt-12 lg:mt-16">
    {
      /*
      Banda celeste:
      - Se posiciona respecto a ESTE bloque.
      - Cubre título, subtítulo, buscador y parte superior de las cards.
    */
    }
    <div class="absolute inset-x-0 top-0 h-[380px] sm:h-[400px] bg-[#dbeaf5]"></div>

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
      <!-- Título y subtítulo dentro de la franja celeste -->
      <div class="text-center pt-4 sm:pt-6 mb-6 lg:pt-8 lg:mb-8">
        <h3 class="text-3xl sm:text-4xl font-bold mb-2" style="color: #39505d;">Propiedades destacadas</h3>
        <p class="text-sm sm:text-base" style="color: #6a8074;">Propiedades seleccionadas para ti</p>
      </div>

      <!-- Buscador centrado (sobre fondo celeste) -->
      <div class="max-w-lg mx-auto mb-8 lg:mb-10">
        <form id="home-search-form" class="flex gap-2">
          <div class="relative flex-1">
            <label class="sr-only" for="home-search">Buscar</label>
            <span class="pointer-events-none absolute inset-y-0 left-4 flex items-center">
              <svg class="h-5 w-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 100-15 7.5 7.5 0 000 15z"></path>
              </svg>
            </span>
            <input
              id="home-search"
              name="q"
              type="search"
              placeholder="Buscar propiedades..."
              class="w-full rounded-xl border border-slate-200 bg-white py-3 pl-11 pr-4 text-sm sm:text-base shadow-sm focus:outline-none focus:ring-2 focus:ring-slate-900/70 focus:border-transparent"
            />
          </div>
          <button
            type="submit"
            class="px-5 py-3 rounded-xl text-white font-semibold text-sm sm:text-base transition-all hover:opacity-90 active:scale-95"
            style="background: #133b34;"
          >
            Buscar
          </button>
        </form>
      </div>

      <script>
        // Manejar búsqueda desde Home con redirección al grid
        document.getElementById('home-search-form')?.addEventListener('submit', function(e) {
          e.preventDefault();
          const input = document.getElementById('home-search') as HTMLInputElement;
          const query = input?.value?.trim();
          if (query) {
            window.location.href = `/propiedades?q=${encodeURIComponent(query)}&page=1#properties-grid`;
          }
        });
      </script>

      <!-- Grid de propiedades (pisando un poco el fondo celeste, resto blanco) -->
      <PropertyGrid properties={properties} client:load />

      <!-- Botón "Ver más" si hay más de 6 propiedades -->
      {
        hasMore && (
          <div class="text-center mt-12 lg:mt-14">
            <a
              href="/propiedades?featured=true"
              class="inline-flex items-center justify-center rounded-md px-8 py-3 text-sm font-semibold text-white transition"
              style="background: #133b34;"
              onmouseover="this.style.background='#0f2d27'"
              onmouseout="this.style.background='#133b34'"
            >
              Ver más propiedades
            </a>
          </div>
        )
      }
    </div>
  </div>
</section>
